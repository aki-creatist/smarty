# 外部ファイルの操作

## 概要

テキストファイルをプログラムで読み書きをする方法

基本は以下の流れ

* ファイルを開く
* 読み込む/書き込む、など処理をする
* ファイルを閉じる

### ファイルを開く

* PHPでファイルを操作するには、まずファイルを開く必要がある
    * ノートを手に取り、表示を開くようなイメージ

* `fopen` - モードを指定してファイルポインタを開く
    * ファイルを開くのに成功すると、戻り値として`ファイルハンドル`を返す
        * ファイルハンドルとは、ファイルを操作する（handle）ための道具
        * ファイルに対して読み書きする場合には、このファイルハンドルを介して行う
    * 選択できるモード
        * `r` - 読み込みモード
        * `w` - 書き込みモード
        * `a` - 追加書きモード

```php
fopen(ファイルパス, モード);
```

### 読み込む/書き込む、など処理をする

```php
$ファイルポインタ = fopen("ファイル名またはURL", "オプション");
読み込み/書き込み($ファイルポインタ, "書き込みデータ");
fclose($ファイルポインタ);
```

#### ファイル読み込み

開いた状態のファイルを読み込む

* `fread`
    * 行末まで読み込む
    * ファイルの最後まで読み込む
    * パラメータとして指定されたバイト数（fread（$ handle、1024）など）まで読み込み
* `fgets`
    * テキストファイルから`1行`を読み込み
* `fgetcsv`
    * 定型フォーマットのテキストを読み込む場合に便利
    * 注：カンマ区切りテキスト（CSVファイル）の処理に特化した関数というわけではない
    * fgetcsv関数は、特定の区切り文字を持ったテキストに汎用的に適応できる
        * ファイルポインタを１行ずつ後ろにずらしながら、現在の行を読み込み
        * 指定された区切り文字で分割した結果を配列として返す
        * 読み込むべき次の行が存在しない場合には、fgetcsv関数はFALSEを返す
* `file_get_contents`
    * 読み込んだファイルの内容を文字列として変数に格納する
    * ファイル名だけでなく、URLを引数に指定して内容を取得することも可能
* `file`
    * 読み込んだファイルの内容を１行ごとに「配列」に取得する

```php
fgets(ファイルハンドル)
```

```php
file_get_contents("ファイル名またはURL");
```

#### ファイル書き込み

開いた状態のファイルに書き込む

* `fputs` - ファイルポインタを通して、書き込み
    * `fwrite` - fputsのエイリアス
* `file_put_contents`
    * `fopen`、`fwrite`、`fclose`の機能を兼ね備えている
    * ファイルがない時は作成され、同名ファイルがある時は上書きされる
    
```php
fputs(ファイルハンドル,書き込む文字列);
```

```php
file_put_contents("ファイル名", $変数);
```

#### ファイルロック

Webアプリの世界では、複数のユーザーが同時に書き込む際の競合を回避する仕組み

* ファイルロック
    * 同時アクセスで生じる競合の防止
        * 同時アクセスで生じる競合の防止＝更新の競合
    * 具体的には自分が使っているファイルに対して鍵をかけること
        * 不特定多数が使用するリソース（資源）を扱う場合には、ファイルに鍵をかける
            * 誰がファイルを操作しているのかわかるようにしておく
    * 処理をひとりひとり順番に行う
        * ユーザーAがファイルを開いて書き込み中に、別のユーザーBがもとのファイルを開いて書き込む場合
            * Aの操作中はBは操作不可にする
        * いつまでもロックしておくとアプリ全体としてのパフォーマンス悪化する
            * できるだけ早く解除するよう工夫する
        
```php
flock(ファイルハンドル, ロックの種類);
```

### ファイルを閉じる

* ファイルに対する操作を終えたら、ファイルを閉じる
    * ファイルを閉じるのは開いていたノートを閉じて、もともとあった棚に片づけることとイメージ
    * ファイルは、スクリプトがすべて終わった時に自動的に閉じるため、必須ではない

```php
fclose(ファイルハンドル);
```

### エラー制御演算子

* `@演算子`と`or die`
    * ファイルオープンに失敗した場合の対処方法
    * エラーに対して、いちいち警告を発生させたくない場合に使用
        * 通常、`fopen`はファイルのオープンに失敗すると、FALSEを返し警告を発する
            * ファイルが存在しない場合に失敗する
            * アクセス権がない場合に失敗するetc
* `@演算子`
    * 実行に失敗しても警告を発生しなくなる
    * ただしそれだけでは問題の箇所できない
* `or die`
    * 指定されたメッセージを出力して、スクリプトを強制的に終了
    * 「fopen...or die...」とは、「ファイルを開きなさい、さもなければ(or)タヒね」

### ファイルを削除する

* `unlink`
    * ファイル名を指定して実行
    * 正常に削除できると変数にTRUEが格納される

```php
unlink("ファイル名");
```